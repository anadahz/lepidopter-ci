language: generic
sudo: true
dist: trusty

env:
  global:
    - BASE_URL=https://get.ooni.torproject.org/lepidopter
    - QEMU_KERNEL_URL=https://github.com/dhruvvyas90/qemu-rpi-kernel/raw/master
    - QEMU_KERNEL=kernel-qemu-4.1.7-jessie
    - USER=lepidopter
    - SSH_PORT=2222
    - SSH_CMD="sshpass -p ${USER} autossh localhost -o StrictHostKeyChecking=no -p ${SSH_PORT} -l ${USER}"

  matrix:
    - IMAGE=lepidopter-v0.3.5-beta-armel.img

before_install:
  - sudo apt-get -qq update
  - sudo apt-get -qq install qemu-system-arm wget xz-utils gnupg kpartx sshpass autossh

install:
  - sudo ./install-dependencies
  - sudo ./prepare-image
  - sudo ./qemu-run &

script:
  - ./wait-for-ssh "${SSH_CMD}" "cat /etc/motd"
  - ./wait-for-ssh "${SSH_CMD}" "ooniprobe --version"
  - ./wait-for-ssh "${SSH_CMD}" "wget -vS -O- localhost:8080"
  - ./wait-for-ssh "${SSH_CMD}" "echo ${USER} | sudo -S journalctl -fu lepidopter-update"
